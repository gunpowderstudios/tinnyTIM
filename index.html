<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>tinnyTIM ‚Äî Sound Therapy & Routine</title>

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 18px;
      line-height: 1.4;
    }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { margin: 0 0 6px; font-size: 24px; }
    .sub { opacity: .85; margin-bottom: 18px; }

    .grid { display: grid; gap: 14px; }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.1fr .9fr; }
    }

    .card {
      border: 1px solid rgba(127,127,127,.25);
      border-radius: 14px;
      padding: 14px;
      background: rgba(127,127,127,.06);
    }

    label { font-size: 13px; opacity: .9; display:block; margin-bottom:4px; }
    input, select, textarea {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(127,127,127,.3);
      background:transparent;
    }
    textarea { resize: vertical; min-height: 80px; }
    input[type="range"] { padding:0; }

    button {
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.15);
      font-weight:600;
      cursor:pointer;
    }
    button.primary { background: rgba(127,127,127,.25); }
    button.danger { background: rgba(255,0,0,.12); border-color: rgba(255,0,0,.35); }
    button:disabled { opacity:.5; cursor:not-allowed; }

    .btns { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .timer {
      font-size: 36px;
      font-weight: 800;
      font-variant-numeric: tabular-nums;
      margin: 10px 0;
    }

    .pill {
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(127,127,127,.25);
      font-size:13px;
    }

    .muted { opacity:.8; font-size:13px; }
    .hr { height:1px; background: rgba(127,127,127,.2); margin:12px 0; }

    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:8px; border-bottom:1px solid rgba(127,127,127,.2); }
    th { text-align:left; opacity:.8; }

  </style>
</head>

<body>
<div class="wrap">

  <h1>tinnyTIM</h1>
  <p class="sub">
    A gentle sound-therapy helper to support tinnitus habituation.  
    Free ‚Ä¢ Offline ‚Ä¢ No accounts ‚Ä¢ No data collected
  </p>

  <div class="grid">

    <!-- PLAYER -->
    <div class="card">

      <label>Sound type</label>
      <select id="noiseType">
        <option value="white">White noise</option>
        <option value="pink">Pink-ish noise</option>
        <option value="brown">Brown-ish noise</option>
        <option value="ocean">Gentle ‚Äúocean‚Äù movement</option>
      </select>

      <label style="margin-top:10px;">Session length (minutes)</label>
      <input id="sessionMins" type="number" min="5" max="180" value="60" />

      <label style="margin-top:10px;">Volume (keep comfortable)</label>
      <input id="vol" type="range" min="0" max="1" step="0.001" value="0.12" />
      <div class="muted">Aim for audible but not intrusive ‚Äî often just below tinnitus.</div>

      <label style="margin-top:10px;">Gentle movement depth</label>
      <input id="amDepth" type="range" min="0" max="1" step="0.01" value="0.25" />

      <div class="hr"></div>

      <label>Optional notch filter</label>
      <select id="notchOn">
        <option value="off">Off</option>
        <option value="on">On</option>
      </select>

      <label style="margin-top:6px;">Notch frequency (Hz)</label>
      <input id="notchHz" type="number" min="80" max="12000" value="6000" />

      <label style="margin-top:6px;">Notch width (Q)</label>
      <input id="notchQ" type="range" min="1" max="40" step="0.5" value="18" />

      <div class="hr"></div>

      <div class="btns">
        <button id="startBtn" class="primary">Start</button>
        <button id="pauseBtn" disabled>Pause</button>
        <button id="stopBtn" disabled>Stop</button>
        <span class="pill">Status: <b id="statusText">Idle</b></span>
      </div>

      <div class="timer" id="timerText">60:00</div>
      <div class="muted" id="timerHint">Start when ready. You can pause anytime.</div>

    </div>

    <!-- LOG -->
    <div class="card">

      <h2 style="margin-top:0;">Daily check-in</h2>

      <label>Loudness (0‚Äì10)</label>
      <input id="loud" type="number" min="0" max="10" value="5" />

      <label>Annoyance / distress (0‚Äì10)</label>
      <input id="annoy" type="number" min="0" max="10" value="4" />

      <label>Sleep (hours)</label>
      <input id="sleep" type="number" min="0" max="16" step="0.5" value="7" />

      <label>Stress (0‚Äì10)</label>
      <input id="stress" type="number" min="0" max="10" value="4" />

      <label>Notes</label>
      <textarea id="notes" placeholder="Anything relevant today?"></textarea>

      <div class="btns" style="margin-top:10px;">
        <button id="saveLogBtn">Save log</button>
        <button id="exportBtn">Export CSV</button>
        <button id="clearBtn" class="danger">Clear all</button>
      </div>

      <div class="hr"></div>
      <div class="muted" id="summaryText">No logs yet.</div>

      <table id="logTable">
        <thead>
          <tr>
            <th>Date</th><th>L</th><th>A</th><th>Sleep</th><th>Stress</th><th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="hr"></div>
      <div class="muted">
        tinnyTIM is an experimental, non-medical tool designed to support habituation.
      </div>

    </div>

  </div>
</div>

<script>
/* ---------------- Utilities ---------------- */
const $ = id => document.getElementById(id);
const pad = n => String(n).padStart(2,'0');
const today = () => new Date().toISOString().slice(0,10);
const STORE = "TINNYTIM_LOGS";

/* ---------------- Audio ---------------- */
let ctx, noise, master, gain, amOsc, amGain, notch;
let running=false, paused=false;

function initAudio(){
  if(ctx) return;
  ctx = new (window.AudioContext||window.webkitAudioContext)();
  master = ctx.createGain();
  master.gain.value = +$("vol").value;
  master.connect(ctx.destination);

  gain = ctx.createGain();
  gain.gain.value = 1;

  amOsc = ctx.createOscillator();
  amOsc.frequency.value = 0.12;
  amGain = ctx.createGain();
  amGain.gain.value = +$("amDepth").value;
  amOsc.connect(amGain).connect(gain.gain);
  amOsc.start();

  notch = ctx.createBiquadFilter();
  notch.type = "notch";
}

function makeNoise(type){
  const node = ctx.createScriptProcessor(4096,1,1);
  let last=0,b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
  node.onaudioprocess=e=>{
    const o=e.outputBuffer.getChannelData(0);
    for(let i=0;i<o.length;i++){
      const w=Math.random()*2-1;
      if(type==="pink"){
        b0=.99886*b0+w*.0555;
        b1=.99332*b1+w*.075;
        b2=.969*b2+w*.153;
        b3=.8665*b3+w*.31;
        b4=.55*b4+w*.533;
        b5=-.7616*b5-w*.0169;
        const p=b0+b1+b2+b3+b4+b5+b6+w*.536;
        b6=w*.1159; o[i]=p*.11;
      } else if(type==="brown"){
        last=(last+.02*w); last=Math.max(-1,Math.min(1,last));
        o[i]=last*3;
      } else if(type==="ocean"){
        last=(last+.018*w); last=Math.max(-1,Math.min(1,last));
        o[i]=(last+(Math.random()*0.04-0.02))*3;
      } else o[i]=w;
    }
  };
  return node;
}

function route(){
  noise.disconnect();
  gain.disconnect();
  notch.disconnect();
  if($("notchOn").value==="on"){
    noise.connect(notch); notch.connect(gain);
  } else noise.connect(gain);
  gain.connect(master);
}

function startAudio(){
  initAudio();
  noise = makeNoise($("noiseType").value);
  route();
  running=true; paused=false;
  $("statusText").textContent="Running";
}

function stopAudio(){
  if(noise) noise.disconnect();
  running=false; paused=false;
  $("statusText").textContent="Idle";
}

/* ---------------- Timer ---------------- */
let total=3600, remain=3600, tick;

function resetTimer(){
  total=(+$("sessionMins").value||60)*60;
  remain=total; renderTimer();
}

function renderTimer(){
  $("timerText").textContent=`${pad(Math.floor(remain/60))}:${pad(remain%60)}`;
}

function startTimer(){
  clearInterval(tick);
  tick=setInterval(()=>{
    if(!running||paused) return;
    remain--; renderTimer();
    if(remain<=0){ stopSession(true); }
  },1000);
}

/* ---------------- Logs ---------------- */
function loadLogs(){ return JSON.parse(localStorage.getItem(STORE)||"[]"); }
function saveLogs(l){ localStorage.setItem(STORE,JSON.stringify(l)); }

function renderLogs(){
  const logs=loadLogs().sort((a,b)=>b.date.localeCompare(a.date));
  const tb=$("logTable").querySelector("tbody");
  tb.innerHTML="";
  logs.forEach(l=>{
    tb.innerHTML+=`<tr><td>${l.date}</td><td>${l.loud}</td><td>${l.annoy}</td><td>${l.sleep}</td><td>${l.stress}</td><td>${l.notes||""}</td></tr>`;
  });
  $("summaryText").textContent=logs.length?`Entries: ${logs.length}`:"No logs yet.";
}

/* ---------------- Events ---------------- */
function startSession(){
  if(ctx?.state==="suspended") ctx.resume();
  resetTimer();
  startAudio();
  startTimer();
  $("pauseBtn").disabled=false;
  $("stopBtn").disabled=false;
}

function stopSession(auto){
  stopAudio();
  clearInterval(tick);
  $("pauseBtn").disabled=true;
  $("stopBtn").disabled=true;
  $("timerHint").textContent=auto?"Session complete üôÇ":"Stopped.";
}

$("startBtn").onclick=startSession;
$("stopBtn").onclick=()=>stopSession(false);
$("pauseBtn").onclick=()=>{
  if(!paused){ ctx.suspend(); paused=true; $("statusText").textContent="Paused"; }
  else{ ctx.resume(); paused=false; $("statusText").textContent="Running"; }
};

$("saveLogBtn").onclick=()=>{
  const logs=loadLogs();
  logs.push({
    date:today(),
    loud:+$("loud").value,
    annoy:+$("annoy").value,
    sleep:+$("sleep").value,
    stress:+$("stress").value,
    notes:$("notes").value.trim()
  });
  saveLogs(logs); renderLogs(); $("notes").value="";
};

$("exportBtn").onclick=()=>{
  const rows=loadLogs();
  if(!rows.length) return alert("No logs");
  let csv="date,loud,annoy,sleep,stress,notes\n";
  rows.forEach(r=>csv+=`${r.date},${r.loud},${r.annoy},${r.sleep},${r.stress},"${r.notes}"\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="tinnyTIM_logs.csv"; a.click();
};

$("clearBtn").onclick=()=>{
  if(confirm("Delete all logs?")){ localStorage.removeItem(STORE); renderLogs(); }
};

$("vol").oninput=()=>master&&(master.gain.value=+$("vol").value);
$("amDepth").oninput=()=>amGain&&(amGain.gain.value=+$("amDepth").value);
$("notchHz").oninput=()=>notch&&(notch.frequency.value=+$("notchHz").value);
$("notchQ").oninput=()=>notch&&(notch.Q.value=+$("notchQ").value);
$("notchOn").onchange=()=>running&&route();
$("noiseType").onchange=()=>running&&(stopAudio(),startAudio());

resetTimer();
renderLogs();
</script>
</body>
</html>
